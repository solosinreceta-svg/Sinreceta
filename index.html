<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PediaCalc v9.1.0</title>
    <link rel="manifest" href="#manifest">
    <style>
        /* Variables CSS con colores UNICEF */
        :root {
            --bg: #f0f8ff; /* Azul claro UNICEF */
            --card: #ffffff;
            --txt: #333333;
            --muted: #666666;
            --accent: #0077cc; /* Azul principal UNICEF */
            --accent-light: #4da6ff; /* Azul claro */
            --accent-dark: #005599; /* Azul oscuro */
            --success: #00aa55; /* Verde UNICEF */
            --warning: #ff9900; /* Naranja UNICEF */
            --danger: #ff4444; /* Rojo UNICEF */
            --sidebar-width: 260px;
            --sidebar-collapsed: 60px;
        }

        [data-theme="dark"] {
            --bg: #0a1a2a; /* Azul oscuro UNICEF */
            --card: #0f253a;
            --txt: #e6f2ff;
            --muted: #aaccff;
            --accent: #4da6ff;
            --accent-light: #66b3ff;
            --accent-dark: #3385cc;
        }

        [data-contrast="high"] {
            --card: #000033;
            --txt: #ffffff;
            --muted: #ffffff;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, Arial, sans-serif;
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--txt);
            transition: all 0.3s ease;
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .header-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 2;
            text-align: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex: 1;
        }

        h1 {
            font-size: 18px;
            margin: 0;
        }

        /* Icono corazón latiendo */
        .heart-icon {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background: #00aa55;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: heartbeat 1.5s ease-in-out infinite both;
        }

        @keyframes heartbeat {
            from {
                transform: scale(1);
                transform-origin: center center;
                animation-timing-function: ease-out;
            }
            10% {
                transform: scale(0.91);
                animation-timing-function: ease-in;
            }
            17% {
                transform: scale(0.98);
                animation-timing-function: ease-out;
            }
            33% {
                transform: scale(0.87);
                animation-timing-function: ease-in;
            }
            45% {
                transform: scale(1);
                animation-timing-function: ease-out;
            }
        }

        .heart-icon::before {
            content: "❤";
            font-size: 24px;
            color: white;
        }

        /* Layout principal */
        .app-container {
            display: flex;
            height: calc(100vh - 64px);
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--card);
            padding: 10px;
            overflow: auto;
            transition: all 0.3s ease;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .sidebar-toggle {
            display: none;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 4px;
            padding: 8px 10px;
            cursor: pointer;
            z-index: 101;
            font-size: 16px;
        }

        .sidebar h3 {
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--accent);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px;
            border: 0;
            background: none;
            border-radius: 6px;
            color: var(--txt);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 4px;
        }

        .sidebar button:hover {
            background: rgba(0, 119, 204, 0.1);
        }

        .sidebar button.active {
            background: linear-gradient(90deg, var(--accent), transparent);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 119, 204, 0.3);
        }

        /* Contenido principal */
        .main-content {
            flex: 1;
            padding: 12px;
            overflow: auto;
            transition: all 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Componentes comunes */
        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .card {
            background: var(--card);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--accent);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            text-align: left;
        }

        input, select, textarea {
            padding: 8px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 6px;
            width: 100%;
            background: var(--card);
            color: var(--txt);
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 119, 204, 0.2);
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        .btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 0;
            background: var(--accent);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn.ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .btn.ghost:hover {
            background: rgba(0, 119, 204, 0.1);
        }

        .btn.success {
            background: var(--success);
        }

        .btn.warning {
            background: var(--warning);
        }

        .btn.danger {
            background: var(--danger);
        }

        .flex {
            display: flex;
            gap: 8px;
        }

        .small {
            font-size: 13px;
            padding: 6px 8px;
        }

        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            z-index: 1000;
        }

        .modal .box {
            width: 960px;
            max-width: 96%;
            max-height: 88vh;
            overflow: auto;
            background: var(--card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        footer {
            padding: 12px;
            text-align: center;
            color: var(--muted);
            font-size: 13px;
            background: var(--card);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* Autocompletado */
        .autocomplete {
            position: relative;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card);
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .autocomplete-item:hover {
            background: rgba(0, 119, 204, 0.1);
        }

        /* Resultados de cálculo */
        .result-box {
            background: rgba(0, 119, 204, 0.05);
            border-left: 4px solid var(--accent);
            padding: 12px;
            border-radius: 4px;
            margin-top: 12px;
        }

        .dose-result {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }

        .dose-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 200px;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar-toggle {
                display: block;
            }

            .sidebar {
                position: fixed;
                height: 100%;
                left: 0;
                top: 64px;
                transform: translateX(-100%);
                z-index: 99;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                width: 100%;
                margin-left: 0;
            }

            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 98;
                display: none;
            }

            .overlay.open {
                display: block;
            }

            .header-center {
                flex: 1;
                text-align: left;
                margin-left: 10px;
            }

            .header-right {
                flex: 0;
            }
        }
    </style>
</head>
<body data-theme="light" data-contrast="normal">
    <header>
        <div class="header-left">
            <button class="sidebar-toggle" id="sidebarToggle">☰</button>
        </div>
        <div class="header-center">
            <h1>PediaCalc v9.1.0</h1>
            <div class="muted">Herramienta para estudiantes de Medicina de Pregrado y Postgrado</div>
        </div>
        <div class="header-right">
            <div class="heart-icon"></div>
        </div>
    </header>

    <div class="app-container">
        <div class="overlay" id="overlay"></div>
        <nav class="sidebar" id="sidebar">
            <h3>Menú Principal</h3>
            <button data-tab="meds">Medicamentos</button>
            <button data-tab="calc" class="active">Calculadora de Dosis</button>
            <button data-tab="dx">Diagnósticos</button>
            <button data-tab="prot">Protocolos</button>
            <button data-tab="conv">Convertidores</button>
            <button data-tab="conf">Configuración</button>
        </nav>

        <main class="main-content" id="main">
            <!-- Medicamentos -->
            <section id="meds" class="tab" style="display:none">
                <div class="row" style="justify-content:space-between">
                    <div><strong>Medicamentos</strong><div class="muted">Lista editable. Añade, edita, elimina.</div></div>
                    <div class="flex">
                        <input id="searchMed" placeholder="Buscar medicamento" style="width:260px"/>
                        <button class="btn" id="addMedBtn">+ Nuevo</button>
                        <button class="btn ghost" id="importBtn">Importar</button>
                        <button class="btn ghost" id="exportBtn">Exportar</button>
                    </div>
                </div>
                <div class="card" style="margin-top:10px">
                    <table>
                        <thead><tr><th>Nombre</th><th>Presentación</th><th>Dosis (mg/kg)</th><th style="width:160px">Acciones</th></tr></thead>
                        <tbody id="medList"></tbody>
                    </table>
                </div>
            </section>

            <!-- Calculadora de Dosis -->
            <section id="calc" class="tab">
                <div class="row" style="justify-content:space-between">
                    <div><strong>Calculadora de Dosis Pediátrica</strong><div class="muted">Cálculo de dosis basado en peso y concentración del medicamento.</div></div>
                </div>

                <div class="card">
                    <h3>Dosis pediátrica</h3>
                    <div class="row">
                        <div style="flex:1" class="autocomplete">
                            <label class="muted">Medicamento</label>
                            <input id="doseMed" type="text" placeholder="Escriba el nombre del medicamento">
                            <div id="autocompleteList" class="autocomplete-items"></div>
                        </div>
                        <div style="width:140px">
                            <label class="muted">Peso (kg)</label>
                            <input id="weight" type="number" min="0" step="0.1" />
                        </div>
                        <div style="width:160px">
                            <label class="muted">Dosis diaria</label>
                            <select id="doseFrequency">
                                <option value="1">1 vez al día</option>
                                <option value="2">2 veces al día</option>
                                <option value="3" selected>3 veces al día</option>
                                <option value="4">4 veces al día</option>
                                <option value="6">6 veces al día</option>
                            </select>
                        </div>
                        <div style="width:140px;align-self:end">
                            <button class="btn success" id="calcDoseBtn">Calcular</button>
                        </div>
                    </div>
                    
                    <div id="dilutionSection" style="margin-top:12px; display:none;">
                        <div class="row">
                            <div style="width:200px">
                                <label class="muted">Dilución (mg/ml)</label>
                                <input id="dilution" type="number" min="0" step="0.1" placeholder="Ej: 10 (para 10mg/ml)" />
                            </div>
                            <div style="align-self:end">
                                <button class="btn ghost" id="applyDilution">Aplicar</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="doseResult" style="margin-top:10px"></div>
                </div>
            </section>

            <!-- Diagnósticos -->
            <section id="dx" class="tab" style="display:none">
                <div class="row" style="justify-content:space-between">
                    <div><strong>Diagnósticos diferenciales</strong><div class="muted">Editable. Guarda localmente.</div></div>
                    <div><button class="btn" id="addDx">+ Nuevo</button></div>
                </div>
                <div class="card">
                    <div id="dxList"></div>
                </div>
            </section>

            <!-- Protocolos -->
            <section id="prot" class="tab" style="display:none">
                <div class="row" style="justify-content:space-between">
                    <div><strong>Protocolos</strong><div class="muted">Editable. Texto simple.</div></div>
                    <div><button class="btn" id="addProt">+ Nuevo</button></div>
                </div>
                <div class="card">
                    <div id="protList"></div>
                </div>
            </section>

            <!-- Convertidores -->
            <section id="conv" class="tab" style="display:none">
                <div class="card">
                    <h3>Convertidores clínicos</h3>
                    <div class="row">
                        <div style="width:160px"><label class="muted">Libras (lb) → Kilogramos (kg)</label><input id="lbToKg" type="number" step="0.01" placeholder="Libras"></div>
                        <div style="align-self:end"><button class="btn" id="convertLbToKg">Convertir</button></div>
                        <div id="lbToKgResult" style="margin-left:12px;align-self:end"></div>
                    </div>
                    <div class="row" style="margin-top:12px">
                        <div style="width:160px"><label class="muted">Kilogramos (kg) → Libras (lb)</label><input id="kgToLb" type="number" step="0.01" placeholder="Kilogramos"></div>
                        <div style="align-self:end"><button class="btn" id="convertKgToLb">Convertir</button></div>
                        <div id="kgToLbResult" style="margin-left:12px;align-self:end"></div>
                    </div>
                    <hr style="margin:16px 0">
                    <div class="row">
                        <div style="width:160px"><label class="muted">°C ↔ °F</label><input id="cC" type="number" step="0.1" placeholder="Temperatura"></div>
                        <div style="align-self:end"><button class="btn ghost" id="toF">C→F</button><button class="btn ghost" id="toC">F→C</button></div>
                        <div id="tempRes" style="margin-left:12px;align-self:end"></div>
                    </div>
                </div>
            </section>

            <!-- Configuración -->
            <section id="conf" class="tab" style="display:none">
                <div class="card">
                    <h3>Configuración</h3>
                    <div class="row">
                        <label class="muted">Tema</label>
                        <select id="themeSel"><option value="light">Claro</option><option value="dark">Oscuro</option></select>
                        <label class="muted" style="margin-left:8px">Alto contraste</label>
                        <select id="contrastSel"><option value="normal">Normal</option><option value="high">Alto</option></select>
                    </div>
                    <div style="margin-top:10px">
                        <button class="btn" id="exportAll">Exportar todo (JSON)</button>
                        <button class="btn ghost" id="importAll">Importar JSON</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <footer>Desarrollado en el Hospital Pediátrico José Ramón Martínez con ❤️.</footer>

    <!-- Modales -->
    <div id="medModal" class="modal" style="display:none">
        <div class="box">
            <h3 id="medModalTitle">Medicamento</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div><label>Nombre</label><input id="mName"></div>
                <div><label>Presentación</label><input id="mPres"></div>
                <div><label>Dosis mg/kg (ej: 10-15)</label><input id="mDose"></div>
                <div><label>Máx mg/dosis</label><input id="mMax"></div>
                <div style="grid-column:1/3"><label>Observaciones</label><textarea id="mNotes" rows="4"></textarea></div>
            </div>
            <div style="margin-top:10px" class="row">
                <button class="btn" id="saveMed">Guardar</button>
                <button class="btn ghost" id="cancelMed">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        /* ---------- Simple IndexedDB wrapper ---------- */
        const DB_NAME = 'pediacalc-db', DB_VERSION = 1;
        let dbPromise = null;
        function openDB(){
            if(dbPromise) return dbPromise;
            dbPromise = new Promise((res,rej)=>{
                const r = indexedDB.open(DB_NAME,DB_VERSION);
                r.onupgradeneeded = e=>{
                    const db = e.target.result;
                    if(!db.objectStoreNames.contains('meds')) db.createObjectStore('meds',{keyPath:'id'});
                    if(!db.objectStoreNames.contains('dx')) db.createObjectStore('dx',{keyPath:'id'});
                    if(!db.objectStoreNames.contains('prot')) db.createObjectStore('prot',{keyPath:'id'});
                    if(!db.objectStoreNames.contains('meta')) db.createObjectStore('meta',{keyPath:'key'});
                }
                r.onsuccess = ()=>res(r.result);
                r.onerror = ()=>rej(r.error);
            });
            return dbPromise;
        }
        async function put(store,obj){ const db = await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).put(obj); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
        async function del(store,key){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).delete(key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
        async function getAll(store){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const r = tx.objectStore(store).getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });}
        async function getOne(store,key){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const r = tx.objectStore(store).get(key); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });}

        /* ---------- Initial seed meds (50 names, dosis vacías para seguridad) ---------- */
        const INITIAL_MEDS = [
            {"id":"m1","name":"Paracetamol","presentation":"Suspensión 120 mg/5 mL","dose":"10-15","max":"","notes":""},
            {"id":"m2","name":"Ibuprofeno","presentation":"Suspensión 100 mg/5 mL","dose":"5-10","max":"","notes":""},
            {"id":"m3","name":"Amoxicilina","presentation":"Suspensión 125 mg/5 mL","dose":"20-40","max":"","notes":""},
            {"id":"m4","name":"Azitromicina","presentation":"Tableta 500 mg / suspensión 200 mg/5 mL","dose":"10","max":"","notes":""},
            {"id":"m5","name":"Cefalexina","presentation":"Suspensión 250 mg/5 mL","dose":"25-50","max":"","notes":""},
            {"id":"m6","name":"Ceftriaxona","presentation":"Polvo inyectable 1 g","dose":"50-100","max":"","notes":"Liofilizado - requiere dilución"},
            {"id":"m7","name":"Amikacina","presentation":"Solución inyectable 100 mg/mL","dose":"15-20","max":"","notes":""},
            {"id":"m8","name":"Gentamicina","presentation":"Solución inyectable 40 mg/mL","dose":"2-2.5","max":"","notes":""},
            {"id":"m9","name":"Cefadroxilo","presentation":"Suspensión 125 mg/5 mL","dose":"30","max":"","notes":""},
            {"id":"m10","name":"Metamizol (Dipirona)","presentation":"Tableta 500 mg / suspensión 500 mg/5 mL","dose":"10-15","max":"","notes":""}
        ];

        /* ---------- Utilities ---------- */
        function uid(prefix='id'){return prefix+Math.random().toString(36).slice(2,9)}
        function el(q,ctx=document){return ctx.querySelector(q)}
        function els(q,ctx=document){return Array.from(ctx.querySelectorAll(q))}

        /* ---------- App state ---------- */
        let state = {activeTab:'calc',sidebarOpen: window.innerWidth > 900}; // Cambiado a 'calc' como pantalla inicial

        /* ---------- Seed DB if empty ---------- */
        async function seedIfEmpty(){
            const meds = await getAll('meds');
            if(meds.length===0){
                for(const m of INITIAL_MEDS) await put('meds',m);
            }
            const dx = await getAll('dx');
            if(dx.length===0){
                await put('dx',{id:uid('dx'),title:'Fiebre en lactante',text:'Causa infecciosa, infecciones virales, infección bacteriana focal...'});
            }
            const prot = await getAll('prot');
            if(prot.length===0) await put('prot',{id:uid('p'),title:'Protocolo inicial',text:'Evaluación ABC, signos vitales, acceso IV, etc.'});
        }

        /* ---------- Render lists ---------- */
        async function renderMeds(filter=''){
            const list = await getAll('meds');
            const tbody = el('#medList'); tbody.innerHTML='';
            const medsSorted = list.sort((a,b)=>a.name.localeCompare(b.name));
            for(const m of medsSorted){
                if(filter && !m.name.toLowerCase().includes(filter.toLowerCase())) continue;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${m.name}</td><td class="muted">${m.presentation||''}</td><td>${m.dose||'<span class="muted">pendiente</span>'}</td>
                <td>
                    <button class="small" data-id="${m.id}" data-action="edit">Editar</button>
                    <button class="small" data-id="${m.id}" data-action="del">Eliminar</button>
                    <button class="small" data-id="${m.id}" data-action="use">Usar</button>
                </td>`;
                tbody.appendChild(tr);
            }
        }

        async function renderDx(){
            const list = await getAll('dx'); const container = el('#dxList'); container.innerHTML='';
            list.forEach(d=>{
                const box=document.createElement('div'); box.className='card';
                box.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${d.title}</strong>
                <div><button class="small" data-id="${d.id}" data-action="editdx">Editar</button>
                <button class="small" data-id="${d.id}" data-action="deldx">Eliminar</button></div></div>
                <div style="margin-top:6px" class="muted">${(d.text||'').substring(0,600)}</div>`;
                container.appendChild(box);
            });
        }

        async function renderProt(){
            const list = await getAll('prot'); const container = el('#protList'); container.innerHTML='';
            list.forEach(d=>{
                const box=document.createElement('div'); box.className='card';
                box.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${d.title}</strong>
                <div><button class="small" data-id="${d.id}" data-action="editprot">Editar</button>
                <button class="small" data-id="${d.id}" data-action="delprot">Eliminar</button></div></div>
                <div style="margin-top:6px" class="muted">${(d.text||'').substring(0,600)}</div>`;
                container.appendChild(box);
            });
        }

        /* ---------- Autocompletado para medicamentos ---------- */
        let currentMedications = [];
        
        async function setupAutocomplete() {
            currentMedications = await getAll('meds');
            
            el('#doseMed').addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const autocompleteList = el('#autocompleteList');
                autocompleteList.innerHTML = '';
                
                if (value.length < 2) {
                    autocompleteList.style.display = 'none';
                    return;
                }
                
                const filteredMeds = currentMedications.filter(med => 
                    med.name.toLowerCase().includes(value)
                );
                
                if (filteredMeds.length === 0) {
                    autocompleteList.style.display = 'none';
                    return;
                }
                
                filteredMeds.forEach(med => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = med.name;
                    item.addEventListener('click', function() {
                        el('#doseMed').value = med.name;
                        autocompleteList.style.display = 'none';
                        
                        // Mostrar sección de dilución si es liofilizado
                        if (med.presentation && med.presentation.toLowerCase().includes('liofilizado')) {
                            el('#dilutionSection').style.display = 'block';
                        } else {
                            el('#dilutionSection').style.display = 'none';
                        }
                    });
                    autocompleteList.appendChild(item);
                });
                
                autocompleteList.style.display = 'block';
            });
            
            // Ocultar autocompletado al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (e.target !== el('#doseMed')) {
                    el('#autocompleteList').style.display = 'none';
                }
            });
        }

        /* ---------- Handlers ---------- */
        el('#addMedBtn').onclick = ()=>{
            el('#medModalTitle').textContent='Nuevo medicamento';
            el('#mName').value=''; el('#mPres').value=''; el('#mDose').value=''; el('#mMax').value=''; el('#mNotes').value='';
            el('#medModal').style.display='flex'; el('#saveMed').dataset.id = '';
        };
        el('#cancelMed').onclick = ()=>{ el('#medModal').style.display='none'; };
        el('#saveMed').onclick = async ()=>{
            const id = el('#saveMed').dataset.id || uid('m');
            const obj = {id,idv:Date.now(),name:el('#mName').value.trim(),presentation:el('#mPres').value.trim(),dose:el('#mDose').value.trim(),max:el('#mMax').value.trim(),notes:el('#mNotes').value.trim()};
            if(!obj.name){ alert('Nombre requerido'); return; }
            await put('meds',obj); el('#medModal').style.display='none'; renderMeds(el('#searchMed').value);
        };

        el('#medList').addEventListener('click', async (ev)=>{
            const a = ev.target.closest('button'); if(!a) return;
            const id = a.dataset.id; const act = a.dataset.action;
            if(act==='edit'){ const m = await getOne('meds',id); el('#medModal').style.display='flex'; el('#medModalTitle').textContent='Editar medicamento'; el('#mName').value=m.name; el('#mPres').value=m.presentation; el('#mDose').value=m.dose; el('#mMax').value=m.max; el('#mNotes').value=m.notes; el('#saveMed').dataset.id = m.id; }
            if(act==='del'){ if(confirm('Eliminar medicamento?')){ await del('meds',id); renderMeds(el('#searchMed').value); } }
            if(act==='use'){ const m = await getOne('meds',id); el('#doseMed').value = m.name; el('#weight').focus(); 
                // Mostrar sección de dilución si es liofilizado
                if (m.presentation && m.presentation.toLowerCase().includes('liofilizado')) {
                    el('#dilutionSection').style.display = 'block';
                } else {
                    el('#dilutionSection').style.display = 'none';
                }
            }
        });

        el('#searchMed').addEventListener('input', ()=>renderMeds(el('#searchMed').value));

        el('#addDx').onclick = async ()=>{
            const title = prompt('Título diagnóstico:'); if(!title) return;
            const text = prompt('Texto (puede editarse luego):')||'';
            await put('dx',{id:uid('dx'),title,text}); renderDx();
        };
        el('#dxList').addEventListener('click',async(ev)=>{
            const btn = ev.target.closest('button'); if(!btn) return;
            const id = btn.dataset.id; if(btn.dataset.action==='editdx'){ const d = await getOne('dx',id); const newTitle = prompt('Título',d.title); const newText = prompt('Texto',d.text); if(newTitle) await put('dx',{id,title:newTitle,text:newText}); renderDx(); }
            if(btn.dataset.action==='deldx'){ if(confirm('Eliminar?')){ await del('dx',id); renderDx(); } }
        });

        el('#addProt').onclick = async ()=>{
            const title = prompt('Título protocolo:'); if(!title) return;
            const text = prompt('Texto del protocolo:')||'';
            await put('prot',{id:uid('p'),title,text}); renderProt();
        };
        el('#protList').addEventListener('click',async(ev)=>{
            const btn = ev.target.closest('button'); if(!btn) return;
            const id = btn.dataset.id; if(btn.dataset.action==='editprot'){ const d = await getOne('prot',id); const nt = prompt('Texto',d.text); if(nt!==null) await put('prot',{id,title:d.title,text:nt}); renderProt(); }
            if(btn.dataset.action==='delprot'){ if(confirm('Eliminar?')){ await del('prot',id); renderProt(); } }
        });

        /* ---------- Calculadora de Dosis ---------- */
        el('#calcDoseBtn').onclick = async ()=>{
            const medName = el('#doseMed').value.trim();
            const w = parseFloat(el('#weight').value);
            const frequency = parseInt(el('#doseFrequency').value);
            const dilution = parseFloat(el('#dilution').value);
            
            if(!medName || !w){ alert('Seleccione medicamento y peso'); return; }
            
            // Buscar el medicamento por nombre
            const meds = await getAll('meds');
            const m = meds.find(med => med.name.toLowerCase() === medName.toLowerCase());
            
            if(!m) { 
                alert('Medicamento no encontrado en la base de datos'); 
                return; 
            }
            
            let res = `<div class="result-box"><strong>${m.name}</strong><div class="muted">Presentación: ${m.presentation||'N/A'}</div>`;
            
            if(m.dose){
                // Extraer el rango de dosis (ej: "10-15")
                const doseRange = m.dose.match(/(\d+(\.\d+)?)\s*-\s*(\d+(\.\d+)?)/);
                let minDose, maxDose;
                
                if(doseRange) {
                    minDose = parseFloat(doseRange[1]);
                    maxDose = parseFloat(doseRange[3]);
                } else {
                    // Si no hay rango, usar un valor único
                    const singleDose = m.dose.match(/(\d+(\.\d+)?)/);
                    if(singleDose) {
                        minDose = maxDose = parseFloat(singleDose[1]);
                    } else {
                        res += `<div class="muted" style="margin-top:6px">Formato de dosis no reconocido. Use formato como "10-15" mg/kg.</div>`;
                        el('#doseResult').innerHTML = res;
                        return;
                    }
                }
                
                // Calcular dosis total diaria
                const dailyMinDose = minDose * w;
                const dailyMaxDose = maxDose * w;
                
                // Aplicar máximo por dosis si existe
                let maxPerDose = m.max ? parseFloat(m.max) : null;
                
                // Calcular dosis por toma
                const dosePerTakeMin = dailyMinDose / frequency;
                const dosePerTakeMax = dailyMaxDose / frequency;
                
                // Aplicar límite máximo por dosis si es necesario
                const finalMinDose = maxPerDose ? Math.min(dosePerTakeMin, maxPerDose) : dosePerTakeMin;
                const finalMaxDose = maxPerDose ? Math.min(dosePerTakeMax, maxPerDose) : dosePerTakeMax;
                
                res += `<div style="margin-top:10px"><strong>Dosis calculada:</strong></div>`;
                res += `<div class="muted">Peso: ${w} kg | Frecuencia: ${frequency} veces al día</div>`;
                
                // Extraer concentración de la presentación (ej: "120 mg/5 mL")
                let concentrationMgPerMl = null;
                const concentrationMatch = m.presentation.match(/(\d+(\.\d+)?)\s*mg\s*\/\s*(\d+(\.\d+)?)\s*mL/);
                if (concentrationMatch) {
                    const mg = parseFloat(concentrationMatch[1]);
                    const ml = parseFloat(concentrationMatch[3]);
                    concentrationMgPerMl = mg / ml;
                }
                
                // Si hay dilución manual, usar esa
                const effectiveConcentration = dilution && dilution > 0 ? dilution : concentrationMgPerMl;
                
                // Mostrar resultados
                res += `<div class="dose-result">`;
                
                // Si hay concentración, calcular en mL
                if (effectiveConcentration && effectiveConcentration > 0) {
                    const mlMin = finalMinDose / effectiveConcentration;
                    const mlMax = finalMaxDose / effectiveConcentration;
                    const dailyMlMin = dailyMinDose / effectiveConcentration;
                    const dailyMlMax = dailyMaxDose / effectiveConcentration;
                    
                    res += `<div class="dose-item">
                        <strong>Por dosis:</strong><br>
                        ${finalMinDose.toFixed(1)} - ${finalMaxDose.toFixed(1)} mg<br>
                        <strong>${mlMin.toFixed(1)} - ${mlMax.toFixed(1)} mL</strong>
                    </div>`;
                    
                    res += `<div class="dose-item">
                        <strong>Diario total:</strong><br>
                        ${dailyMinDose.toFixed(1)} - ${dailyMaxDose.toFixed(1)} mg<br>
                        <strong>${dailyMlMin.toFixed(1)} - ${dailyMlMax.toFixed(1)} mL</strong>
                    </div>`;
                    
                    res += `<div class="dose-item">
                        <strong>Concentración:</strong><br>
                        ${effectiveConcentration.toFixed(2)} mg/mL
                    </div>`;
                } else {
                    res += `<div class="dose-item">
                        <strong>Por dosis:</strong><br>
                        ${finalMinDose.toFixed(1)} - ${finalMaxDose.toFixed(1)} mg
                    </div>`;
                    
                    res += `<div class="dose-item">
                        <strong>Diario total:</strong><br>
                        ${dailyMinDose.toFixed(1)} - ${dailyMaxDose.toFixed(1)} mg
                    </div>`;
                }
                
                res += `</div>`;
                
                if(maxPerDose) {
                    res += `<div class="muted" style="margin-top:6px">Límite máximo por dosis: ${maxPerDose} mg</div>`;
                }
                
                if(m.presentation && m.presentation.toLowerCase().includes('liofilizado') && !dilution) {
                    res += `<div class="muted" style="margin-top:6px;color:var(--warning)">Nota: Este medicamento es liofilizado. Especifique la dilución para calcular mL.</div>`;
                }
            } else {
                res += `<div class="muted" style="margin-top:6px">Campo dosis vacío. Rellene según guía local en editar medicamento.</div>`;
            }
            
            res += `</div>`;
            el('#doseResult').innerHTML = res;
        };

        // Aplicar dilución
        el('#applyDilution').onclick = () => {
            // Simplemente recalcula la dosis
            el('#calcDoseBtn').click();
        };

        /* ---------- Convertidores ---------- */
        el('#convertLbToKg').onclick = ()=>{ 
            const lb=parseFloat(el('#lbToKg').value); 
            if(isNaN(lb)){ el('#lbToKgResult').textContent='-'; return; } 
            el('#lbToKgResult').textContent = `${(lb * 0.453592).toFixed(2)} kg`; 
        }
        
        el('#convertKgToLb').onclick = ()=>{ 
            const kg=parseFloat(el('#kgToLb').value); 
            if(isNaN(kg)){ el('#kgToLbResult').textContent='-'; return; } 
            el('#kgToLbResult').textContent = `${(kg * 2.20462).toFixed(2)} lb`; 
        }
        
        el('#toF').onclick = ()=>{ 
            const c=parseFloat(el('#cC').value); 
            if(isNaN(c)){ el('#tempRes').textContent='-'; return; } 
            el('#tempRes').textContent = `${(c*9/5+32).toFixed(1)} °F`; 
        }
        
        el('#toC').onclick = ()=>{ 
            const f=parseFloat(el('#cC').value); 
            if(isNaN(f)){ el('#tempRes').textContent='-'; return; } 
            el('#tempRes').textContent = `${((f-32)*5/9).toFixed(1)} °C`; 
        }

        /* ---------- Export / Import ---------- */
        el('#exportBtn').onclick = async ()=>{
            const meds = await getAll('meds'); const dx = await getAll('dx'); const prot = await getAll('prot');
            const blob = new Blob([JSON.stringify({meds,dx,prot},null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download='pediacalc-backup.json'; a.click(); URL.revokeObjectURL(url);
        };
        
        el('#importBtn').onclick = ()=>{ uploadJSON(processImport) };
        el('#exportAll').onclick = ()=> el('#exportBtn').click();
        el('#importAll').onclick = ()=> el('#importBtn').click();

        function uploadJSON(cb){
            const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
            inp.onchange = async ()=>{ const f = inp.files[0]; const t = await f.text(); try{ const j = JSON.parse(t); cb(j); }catch(e){ alert('JSON inválido') } };
            inp.click();
        }
        
        async function processImport(json){
            if(json.meds) for(const m of json.meds) await put('meds',m);
            if(json.dx) for(const d of json.dx) await put('dx',d);
            if(json.prot) for(const p of json.prot) await put('prot',p);
            await refreshAll();
        }

        /* ---------- UI Tabs and sidebar ---------- */
        function setupUI() {
            // Tabs
            els('nav button').forEach(b=>b.onclick = ()=>{
                els('nav button').forEach(x=>x.classList.remove('active')); 
                b.classList.add('active');
                const t = b.dataset.tab; 
                state.activeTab=t; 
                els('main .tab').forEach(s=>s.style.display='none'); 
                el('#'+t).style.display='block';
                
                // Cerrar sidebar en móviles
                if (window.innerWidth <= 900) {
                    toggleSidebar(false);
                }
            });

            // Sidebar toggle
            el('#sidebarToggle').onclick = () => {
                toggleSidebar();
            };

            // Overlay para cerrar sidebar en móviles
            el('#overlay').onclick = () => {
                toggleSidebar(false);
            };

            // Configuración de tema
            el('#themeSel').value = localStorage.getItem('pcalc_theme') || 'light';
            el('#contrastSel').value = localStorage.getItem('pcalc_contrast') || 'normal';
            
            el('#themeSel').onchange = (e) => {
                document.body.setAttribute('data-theme', e.target.value);
                localStorage.setItem('pcalc_theme', e.target.value);
            };
            
            el('#contrastSel').onchange = (e) => {
                document.body.setAttribute('data-contrast', e.target.value);
                localStorage.setItem('pcalc_contrast', e.target.value);
            };

            // Aplicar tema guardado
            document.body.setAttribute('data-theme', localStorage.getItem('pcalc_theme') || 'light');
            document.body.setAttribute('data-contrast', localStorage.getItem('pcalc_contrast') || 'normal');
        }

        function toggleSidebar(force) {
            if (force !== undefined) {
                state.sidebarOpen = force;
            } else {
                state.sidebarOpen = !state.sidebarOpen;
            }
            
            if (window.innerWidth > 900) {
                // Escritorio
                if (state.sidebarOpen) {
                    el('#sidebar').classList.remove('collapsed');
                    el('#main').classList.remove('expanded');
                } else {
                    el('#sidebar').classList.add('collapsed');
                    el('#main').classList.add('expanded');
                }
            } else {
                // Móvil
                if (state.sidebarOpen) {
                    el('#sidebar').classList.add('open');
                    el('#overlay').classList.add('open');
                } else {
                    el('#sidebar').classList.remove('open');
                    el('#overlay').classList.remove('open');
                }
            }
        }

        /* ---------- Init ---------- */
        async function refreshAll(){ 
            await renderMeds(el('#searchMed').value); 
            await renderDx(); 
            await renderProt(); 
            await setupAutocomplete();
        }
        
        async function init(){
            await seedIfEmpty(); 
            await refreshAll();
            setupUI();
            
            // Ajustar sidebar según tamaño de pantalla
            window.addEventListener('resize', () => {
                if (window.innerWidth > 900) {
                    state.sidebarOpen = true;
                    el('#sidebar').classList.remove('open');
                    el('#overlay').classList.remove('open');
                } else {
                    state.sidebarOpen = false;
                }
            });
        }

        init();
    </script>

    <!-- Minimal manifest inline (browser support limited) -->
    <script type="application/json" id="manifest">
    {
        "name":"PediaCalc v9.1.0",
        "short_name":"PediaCalc",
        "start_url":".",
        "display":"standalone",
        "background_color":"#f0f8ff",
        "theme_color":"#0077cc"
    }
    </script>
</body>
</html>